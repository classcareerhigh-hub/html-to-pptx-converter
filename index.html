<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Career High Strategy Deck: ZENITH V7</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>

  <style>
    /* V7 ZENITH UI - Transcendence */
    :root { 
        --core: #6366f1; /* Indigo */
        --bg: #0f172a; 
        --panel: #1e293b; 
        --text: #f8fafc;
        --success: #10b981;
    }
    
    * { margin:0; padding:0; box-sizing:border-box; }
    
    body { 
        font-family: 'Inter', 'Pretendard', sans-serif; 
        background: var(--bg); color: var(--text);
        height: 100vh; display: flex; overflow: hidden;
    }
    
    .layout { display: grid; grid-template-columns: 360px 1fr; width: 100%; height: 100%; }
    
    /* Left Panel: Intelligence */
    .sidebar { 
        background: var(--panel); border-right: 1px solid #334155;
        padding: 30px; display: flex; flex-direction: column; gap: 20px;
        box-shadow: 10px 0 30px rgba(0,0,0,0.3); z-index: 10;
    }
    
    .brand { font-size: 24px; font-weight: 900; letter-spacing: -1px; margin-bottom: 10px; }
    .brand span { color: var(--core); }
    
    .status-card {
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
        padding: 15px; border-radius: 8px; font-size: 13px;
    }
    .status-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .status-val { font-family: monospace; color: var(--core); }

    .btn-generate {
        background: var(--core); color: white; border: none;
        padding: 18px; border-radius: 8px; font-weight: 700; font-size: 15px;
        cursor: pointer; margin-top: auto; transition: 0.2s;
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
    }
    .btn-generate:hover { background: #4f46e5; transform: translateY(-2px); }
    .btn-generate:disabled { background: #475569; cursor: not-allowed; transform: none; box-shadow: none; }

    /* Right Panel: Editor */
    .editor-area { display: flex; flex-direction: column; background: #0b0f19; }
    
    .editor-header {
        padding: 15px 30px; border-bottom: 1px solid #334155;
        font-size: 12px; color: #94a3b8; font-weight: 600; text-transform: uppercase;
        display: flex; justify-content: space-between;
    }
    
    textarea {
        flex: 1; width: 100%; border: none; padding: 40px;
        background: transparent; color: #e2e8f0;
        font-family: 'D2Coding', monospace; font-size: 14px; line-height: 1.7;
        resize: none; outline: none;
    }

    /* Helper Classes for User Input */
    .hint { font-size: 11px; color: #64748b; margin-top: 5px; }
    .tag { display: inline-block; padding: 2px 6px; background: #334155; border-radius: 4px; font-family: monospace; font-size: 11px; }

  </style>
</head>
<body>

<div class="layout">
    <div class="sidebar">
        <div class="brand">ZENITH <span>V7</span></div>
        <p style="font-size:13px; color:#94a3b8; line-height:1.5;">
            Self-Correcting Layout Engine with Auto-Pagination.
        </p>
        
        <div class="status-card">
            <div style="font-weight:700; margin-bottom:10px; color:#fff;">INTELLIGENCE CORE</div>
            <div class="status-item">
                <span>Overflow Check</span>
                <span class="status-val">ACTIVE</span>
            </div>
            <div class="status-item">
                <span>Header Cloning</span>
                <span class="status-val">ACTIVE</span>
            </div>
            <div class="status-item">
                <span>Semantic Color</span>
                <span class="status-val">ACTIVE</span>
            </div>
        </div>

        <div class="hint">
            <strong>New Classes Supported:</strong><br>
            <span class="tag">.text-red</span> <span class="tag">.text-green</span> <span class="tag">.indent</span>
        </div>

        <div id="msgBox" style="font-size:12px; text-align:center; min-height:20px; color:#10b981;"></div>
        <button id="genBtn" class="btn-generate">INITIALIZE ZENITH</button>
    </div>

    <div class="editor-area">
        <div class="editor-header">
            <span>HTML SOURCE</span>
            <span>UTF-8 MODE</span>
        </div>
        <textarea id="input" placeholder='<div class="slide">
  <div class="action-title">시장 분석 결과</div>
  <div class="content">
    <div class="row">
       <div class="box">
         <div class="box-title">리스크 요인</div>
         <p class="text-red">경쟁사의 공격적 마케팅</p>
       </div>
    </div>
  </div>
</div>'></textarea>
    </div>
</div>

<script>
    const genBtn = document.getElementById('genBtn');
    const input = document.getElementById('input');
    const msgBox = document.getElementById('msgBox');

    // ★ ZENITH CONFIGURATION ★
    const CONF = {
        primary: '0071EC',
        danger: 'DC2626', // Red
        success: '059669', // Green
        text: '1F2937',
        muted: '4B5563',
        bgBox: 'F3F4F6',
        line: 'E5E7EB',
        font: "Malgun Gothic",
        
        // Layout Limits
        slideH: 5.625, // 16:9 Height (inches)
        footerY: 5.2,  // Footer Line
        margin: 0.5,
        contentW: 9.0,
        headerBottom: 1.4 // Where content starts
    };

    function uiMsg(txt, isErr) {
        msgBox.textContent = txt;
        msgBox.style.color = isErr ? '#EF4444' : '#10B981';
    }

    genBtn.addEventListener('click', async () => {
        const html = input.value.trim();
        if(!html) return uiMsg('No Input Code', true);

        uiMsg('Processing...');
        genBtn.disabled = true;

        try {
            let pptx;
            if (typeof window.PptxGenJS === 'function') pptx = new window.PptxGenJS();
            else pptx = new PptxGenJS();
            
            pptx.layout = 'LAYOUT_16x9';
            pptx.author = 'Zenith AI';

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const slides = doc.querySelectorAll('.slide');

            slides.forEach((slideElem, idx) => {
                // --- 1. Header Analysis (Context Extraction) ---
                const titleNode = slideElem.querySelector('.action-title, h1');
                const titleText = titleNode ? titleNode.textContent.trim() : '';
                const isCover = (idx === 0 && slideElem.querySelector('.big-stat'));

                // Create initial slide
                let slide = pptx.addSlide();
                let curY = renderHeader(slide, titleText, isCover, slideElem);
                let pageIndex = 1;

                if(isCover) {
                    // 표지는 페이지네이션 로직 제외
                    return; 
                }

                // --- 2. Intelligent Content Loop (With Pagination) ---
                const contentDiv = slideElem.querySelector('.content') || slideElem;
                
                // Get all logical blocks (rows or standalone elements)
                // Filter out header elements
                const blocks = Array.from(contentDiv.children).filter(el => 
                    !el.classList.contains('header') && 
                    !el.classList.contains('action-title') &&
                    !el.classList.contains('footer')
                );

                blocks.forEach(block => {
                    // [Pre-Calculation]
                    // 블록을 렌더링하기 전에 높이를 예측합니다.
                    let blockHeight = 0;
                    let isRow = block.classList.contains('row');

                    if (isRow) {
                        const cols = Array.from(block.children);
                        const gap = 0.2;
                        const colW = (CONF.contentW - (gap * (cols.length - 1))) / cols.length;
                        
                        // Row의 높이는 가장 긴 Col의 높이
                        let maxColH = 0;
                        cols.forEach(col => {
                            const h = estimateBlockHeight(col, colW - 0.4); // padding 제외
                            if(h > maxColH) maxColH = h;
                        });
                        blockHeight = Math.max(maxColH, 2.0); // 최소 높이
                    } else {
                        // 일반 블록 (Table or Text)
                        if(block.tagName === 'TABLE' || block.classList.contains('data-table')) {
                            blockHeight = (block.querySelectorAll('tr').length * 0.4) + 0.5;
                        } else {
                            blockHeight = estimateBlockHeight(block, CONF.contentW);
                        }
                    }

                    // [Pagination Trigger]
                    // 현재 위치 + 블록 높이가 Footer 영역을 침범하면 -> 새 슬라이드 생성
                    if (curY + blockHeight > CONF.footerY) {
                        // Add New Slide (Continuation)
                        slide = pptx.addSlide();
                        pageIndex++;
                        
                        // Header Copy (Context Retention)
                        renderHeader(slide, titleText + ` (${pageIndex})`, false, null);
                        curY = CONF.headerBottom; // Reset Y
                    }

                    // [Render]
                    if (isRow) {
                        renderRow(slide, block, curY, blockHeight);
                    } else {
                        renderBlock(slide, block, curY, blockHeight);
                    }
                    
                    curY += blockHeight + 0.3; // Add Margin Bottom
                });

                // Footer Number
                // (Note: PptxGenJS master slides are better for this, but simplistic approach here)
                // 현재 코드 구조상 루프 내에서 처리하기 복잡하므로, 마지막 장 번호만 남거나 함.
                // *Zenith Fix*: 페이지네이션 된 슬라이드들은 Loop 안에서 생성되므로, 
                // 전역적으로 슬라이드 번호를 매기는 로직이 필요하나, 여기서는 단순화.
            });

            await pptx.writeFile({ fileName: 'Zenith_V7_AutoPaging.pptx' });
            uiMsg('Zenith Build Complete.', false);

        } catch (e) {
            console.error(e);
            uiMsg('Fatal Error: ' + e.message, true);
        } finally {
            genBtn.disabled = false;
        }
    });

    // --- ENGINE CORE ---

    function renderHeader(slide, text, isCover, dom) {
        slide.background = { color: 'FFFFFF' };
        
        if (isCover) {
            // Cover Render Logic
            slide.addText(text, { x:0.5, y:2.5, w:9, h:1.5, fontSize:44, color:CONF.primary, bold:true, align:'center', fontFace:CONF.font });
            if(dom) {
                const sub = dom.querySelector('.subtitle, h2');
                if(sub) slide.addText(sub.textContent.trim(), { x:1, y:4, w:8, fontSize:20, color:CONF.muted, align:'center', fontFace:CONF.font });
            }
            return 6.0;
        } else {
            // Content Header
            slide.addText(text, { x:0.5, y:0.4, w:9, fontSize:24, color:CONF.text, bold:true, fontFace:CONF.font, valign:'top' });
            slide.addShape(pptx.ShapeType.line, { x:0.5, y:1.1, w:9, h:0, line:{color:CONF.primary, width:2} });
            return CONF.headerBottom;
        }
    }

    function estimateBlockHeight(el, w) {
        let h = 0.4; // Base padding
        if(el.querySelector('.box-title, h3')) h += 0.5;
        if(el.querySelector('.big-stat')) h += 1.2;
        
        const texts = el.querySelectorAll('p, li, .box-text');
        texts.forEach(t => {
            const txt = t.textContent.trim();
            if(!txt) return;
            const lines = Math.ceil(txt.length / (w * 6.5));
            h += (lines * 0.28) + 0.15;
        });
        return h;
    }

    function renderRow(slide, rowDom, y, height) {
        const cols = Array.from(rowDom.children);
        const gap = 0.2;
        const colW = (CONF.contentW - (gap * (cols.length - 1))) / cols.length;

        cols.forEach((col, i) => {
            const x = CONF.margin + (i * (colW + gap));
            
            // Background
            if(col.classList.contains('box') || col.querySelector('.box')) {
                slide.addShape(pptx.ShapeType.roundRect, {
                    x:x, y:y, w:colW, h:height,
                    fill:{color:CONF.bgBox}, line:{color:CONF.line, width:1}
                });
            }

            // Content (Vertical Center Logic from V6)
            const contentH = estimateBlockHeight(col, colW - 0.4);
            const offset = Math.max(0, (height - contentH) / 2); // Center alignment
            
            renderInnerContent(slide, col, x + 0.2, y + offset, colW - 0.4);
        });
    }

    function renderBlock(slide, block, y, height) {
        if(block.tagName === 'TABLE' || block.classList.contains('data-table')) {
            // Table Render
            const rows = [];
            block.querySelectorAll('tr').forEach((tr, rIdx) => {
                const rowData = [];
                tr.querySelectorAll('td, th').forEach(cell => {
                    const isHead = cell.tagName === 'TH' || tr.parentElement.tagName === 'THEAD';
                    rowData.push({
                        text: cell.textContent.trim(),
                        options: {
                            fill: isHead ? CONF.primary : (rIdx%2===0 ? 'FFFFFF' : 'F9FAFB'),
                            color: isHead ? 'FFFFFF' : CONF.text,
                            bold: isHead, fontSize:10, fontFace:CONF.font,
                            border:{color:CONF.line, pt:1}, align: isHead ? 'center' : 'left'
                        }
                    });
                });
                rows.push(rowData);
            });
            if(rows.length > 0) slide.addTable(rows, { x:CONF.margin, y:y, w:CONF.contentW, rowH:0.4 });
        } else {
            // Standard Text Block
            renderInnerContent(slide, block, CONF.margin, y, CONF.contentW);
        }
    }

    function renderInnerContent(slide, el, x, y, w) {
        let curY = y;

        // Title
        const title = el.querySelector('.box-title, h3');
        if(title) {
            slide.addText(title.textContent.trim(), {
                x:x, y:curY, w:w, h:0.4, fontSize:14, color:CONF.primary, bold:true, fontFace:CONF.font
            });
            curY += 0.5;
        }

        // Big Stat
        const stat = el.querySelector('.big-stat');
        if(stat) {
            slide.addText(stat.textContent.trim(), {
                x:x, y:curY, w:w, h:0.8, fontSize:36, color:CONF.primary, bold:true, align:'center', fontFace:'Arial'
            });
            curY += 0.8;
        }

        // Text & Lists
        const nodes = el.querySelectorAll('p, li, .box-text');
        nodes.forEach(node => {
            if(node.closest('.big-stat') || node.classList.contains('box-title')) return;
            
            const txt = node.textContent.trim();
            const isList = node.tagName === 'LI';
            
            // Semantic Color Check
            let color = CONF.muted;
            if(node.classList.contains('text-red')) color = CONF.danger;
            if(node.classList.contains('text-green')) color = CONF.success;
            if(node.classList.contains('orange-text')) { color = CONF.primary; } // 호환성

            // Indentation
            let indent = 0;
            if(node.classList.contains('indent')) indent = 1; // Simple indent logic

            const lines = Math.ceil(txt.length / (w * 6.5));
            const h = (lines * 0.28) + 0.1;

            slide.addText(txt, {
                x:x, y:curY, w:w, h:h, fontSize:11, color:color,
                bullet: isList ? { indent:10 * (indent+1) } : false,
                indentLevel: indent,
                breakLine:true, fontFace:CONF.font
            });
            curY += h;
        });
    }
</script>
</body>
</html>
