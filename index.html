<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Career High PT Converter (Strict Mode)</title>
  
  <!-- 라이브러리 로드 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>

  <style>
    /* UI 스타일 (기존과 동일하므로 축약) */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system, sans-serif; background:#F4F6F8; padding:20px; display:flex; justify-content:center; }
    .container { width:100%; max-width:1000px; background:white; padding:40px; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.08); }
    h1 { color:#0071EC; text-align:center; margin-bottom:30px; }
    textarea { width:100%; height:300px; padding:15px; border:2px solid #E5E7EB; border-radius:8px; font-family:'Consolas', monospace; resize:vertical; }
    button { background:#0071EC; color:white; border:none; padding:15px; width:100%; border-radius:8px; font-size:18px; font-weight:bold; cursor:pointer; margin-top:20px; }
    button:hover { background:#005bbd; }
    .status { margin-top:20px; text-align:center; font-weight:bold; color:#0071EC; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Career High PT Generator (Strict)</h1>
    <textarea id="htmlInput" placeholder="Claude가 생성한 HTML 코드를 여기에 붙여넣으세요..."></textarea>
    <button id="convertBtn">PPTX로 변환하기 (Strict Mode)</button>
    <div id="statusMessage" class="status"></div>
  </div>

  <script>
    const convertBtn = document.getElementById('convertBtn');
    const htmlInput = document.getElementById('htmlInput');
    const statusMessage = document.getElementById('statusMessage');

    // [중요] PPTX 좌표/크기 상수 정의 (단위: 인치)
    // 16:9 슬라이드 크기 = 10 x 5.625 인치
    const LAYOUT = {
        MARGIN_LEFT: 0.5,
        width: 9.0, // 좌우 여백 0.5씩 뺌
        y_h2: 0.4,  // 소제목 위치
        y_h1: 0.8,  // 대제목 위치
        y_body: 2.0 // 본문 시작 위치
    };

    convertBtn.addEventListener('click', async () => {
      const html = htmlInput.value.trim();
      if (!html) return alert('HTML 코드를 입력하세요.');

      convertBtn.disabled = true;
      convertBtn.textContent = '변환 중...';

      try {
        let pptx = new PptxGenJS();
        pptx.layout = 'LAYOUT_16x9';
        pptx.author = 'Career High';
        pptx.title = 'Presentation';

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const slides = doc.querySelectorAll('.slide');

        if (slides.length === 0) throw new Error('슬라이드(.slide)를 찾을 수 없습니다.');

        slides.forEach((slideElem) => {
          const slide = pptx.addSlide();
          slide.background = { color: 'FFFFFF' };

          // Y축 커서 (현재 높이 추적)
          let currentY = LAYOUT.y_body;

          // 1. 소제목 (H2) - 고정 위치
          const h2 = slideElem.querySelector('h2');
          if (h2) {
            slide.addText(h2.textContent.trim(), {
              x: LAYOUT.MARGIN_LEFT, y: LAYOUT.y_h2, w: LAYOUT.width, h: 0.3,
              fontSize: 14, color: '0071EC', bold: true, fontFace: 'Arial'
            });
          }

          // 2. 대제목 (H1) - 고정 위치
          const h1 = slideElem.querySelector('h1');
          if (h1) {
            let titleText = h1.innerHTML.replace(/<br\s*\/?>/gi, '\n');
            const temp = document.createElement('div');
            temp.innerHTML = titleText;
            
            slide.addText(temp.textContent, {
              x: LAYOUT.MARGIN_LEFT, y: LAYOUT.y_h1, w: LAYOUT.width,
              fontSize: 36, color: '111111', bold: true, fontFace: 'Arial',
              lineSpacing: 42 // 줄간격 꽉 조임
            });
          }

          // --- 여기서부터 유동 콘텐츠 ---

          // 3. Key Box (강조 박스)
          const keyBox = slideElem.querySelector('.key-box');
          if (keyBox) {
            // 박스 그리기
            slide.addShape(pptx.ShapeType.rect, {
              x: LAYOUT.MARGIN_LEFT, y: currentY, w: LAYOUT.width, h: 0.9,
              fill: { color: 'F0F7FF' },
              line: { color: '0071EC', width: 2 } // 전체 테두리로 변경하여 깔끔함 유지
            });
            // 텍스트 넣기
            slide.addText(keyBox.textContent.trim(), {
              x: LAYOUT.MARGIN_LEFT + 0.2, y: currentY + 0.1, w: LAYOUT.width - 0.4,
              fontSize: 16, color: '004085', bold: true, fontFace: 'Arial',
              align: 'left'
            });
            currentY += 1.2; // 박스 높이 + 여백만큼 이동
          }

          // 4. 본문 (P)
          const ps = slideElem.querySelectorAll('p:not(.key-box)');
          ps.forEach(p => {
             // 텍스트 길이 체크하여 높이 계산 (대략적)
             const textLen = p.textContent.length;
             const estHeight = textLen > 80 ? 0.8 : 0.4;

             slide.addText(p.textContent.trim(), {
               x: LAYOUT.MARGIN_LEFT, y: currentY, w: LAYOUT.width, h: estHeight,
               fontSize: 16, color: '333333', fontFace: 'Arial', lineSpacing: 22,
               align: 'justify' // 양쪽 정렬로 깔끔하게
             });
             currentY += estHeight + 0.2;
          });

          // 5. 리스트 (UL)
          const ul = slideElem.querySelector('ul');
          if (ul) {
            const lis = ul.querySelectorAll('li');
            lis.forEach(li => {
              slide.addText('• ' + li.textContent.trim(), {
                x: LAYOUT.MARGIN_LEFT + 0.2, y: currentY, w: LAYOUT.width - 0.2, h: 0.4,
                fontSize: 15, color: '444444', fontFace: 'Arial'
              });
              currentY += 0.45;
            });
            currentY += 0.2;
          }

          // 6. 데이터 표 (Table) - 가장 중요!
          const table = slideElem.querySelector('table');
          if (table) {
            const rows = [];
            
            // 헤더 처리
            const thead = table.querySelector('thead');
            if (thead) {
              const ths = thead.querySelectorAll('th');
              rows.push(Array.from(ths).map(th => ({
                text: th.textContent.trim(),
                options: { 
                  fill: '0071EC', color: 'FFFFFF', bold: true, 
                  fontSize: 12, align: 'center', valign: 'middle'
                }
              })));
            }

            // 본문 처리
            const trs = table.querySelectorAll('tbody tr');
            trs.forEach(tr => {
              const tds = tr.querySelectorAll('td');
              rows.push(Array.from(tds).map(td => ({
                text: td.textContent.trim(),
                options: { 
                  fontSize: 11, color: '333333', fill: 'FFFFFF', 
                  align: 'center', valign: 'middle',
                  border: { pt: 1, color: 'E1E1E1' } // 셀 테두리 연하게
                }
              })));
            });

            if (rows.length > 0) {
              slide.addTable(rows, {
                x: LAYOUT.MARGIN_LEFT, y: currentY, w: LAYOUT.width,
                rowH: 0.4, // 행 높이 고정
                border: { color: '0071EC', pt: 2 } // 외곽 테두리 진하게
              });
              // 표 높이만큼 커서 이동 (행 개수 * 0.4)
              currentY += (rows.length * 0.4) + 0.5;
            }
          }

          // 7. 페이지 번호
          const pageNum = slideElem.getAttribute('data-page');
          if (pageNum) {
            slide.addText(pageNum, { 
              x: 9.2, y: 5.2, fontSize: 10, color: 'BBBBBB', bold: true 
            });
          }
        });

        await pptx.writeFile({ fileName: 'Presentation_Strict.pptx' });
        statusMessage.textContent = '✅ 완료! 파일이 다운로드되었습니다.';

      } catch (error) {
        console.error(error);
        alert('오류 발생: ' + error.message);
        convertBtn.disabled = false;
        convertBtn.textContent = 'PPTX로 변환하기 (Strict Mode)';
      }
    });
  </script>
</body>
</html>
